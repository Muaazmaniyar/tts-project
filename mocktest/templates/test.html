{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mock Test</title>
<link rel="stylesheet" href="{% static 'css/test.css' %}">

<style>
  /* Sidebar buttons */
  .question-grid button.active-question { background: #007bff; color: #fff; }
  .question-grid button.answered { background: #28a745; color: #fff; }

  /* Timer warning styles */
  #timer.warning { color: orange; }
  #timer.danger { color: red; animation: blink 1s infinite; }
  @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
</style>
</head>
<body>
<div class="container">

  <!-- Sidebar -->
  <aside class="sidebar">
    <img src="{% static 'images/technokraft-logo.png' %}" alt="Logo">
    <p><strong>Choose a Question</strong></p>
    <div class="question-grid">
      {% for q in questions %}
      <button type="button" id="qbtn-{{ forloop.counter0 }}" data-answered="false"
              onclick="goToQuestion({{ forloop.counter0 }})">
        {{ forloop.counter }}
      </button>
      {% endfor %}
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <header class="header">
      <h3>{{selected_subject}} Mock Test</h3>
      <p><strong>Time Left:</strong> <span id="timer">60:00</span></p>
    </header>

    <form id="mcq-test-form" method="post">
      {% csrf_token %}
      {% for question in questions %}
      <div class="question" data-index="{{ forloop.counter0 }}" style="display:none;">
        <div class="question-box">
          <h3>Q{{ forloop.counter }}: {{ question.question_text }}</h3>
        </div>
        <div class="answer-box">
          <label><input type="radio" name="question_{{ question.id }}" value="{{ question.option1 }}"> {{ question.option1 }}</label>
          <label><input type="radio" name="question_{{ question.id }}" value="{{ question.option2 }}"> {{ question.option2 }}</label>
          <label><input type="radio" name="question_{{ question.id }}" value="{{ question.option3 }}"> {{ question.option3 }}</label>
          <label><input type="radio" name="question_{{ question.id }}" value="{{ question.option4 }}"> {{ question.option4 }}</label>
        </div>
      </div>
      {% endfor %}

      <div class="action-buttons">
        <button type="button" id="prev-btn">Previous</button>
        <button type="button" id="next-btn">Next</button>
        <button type="submit" id="submit-btn">Submit Test</button>
      </div>
    </form>
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const questions = document.querySelectorAll('.question');
  const examForm = document.getElementById('mcq-test-form');
  const display = document.getElementById('timer');
  let currentQuestionIndex = 0;
  let timerInterval = null;
  let examActive = true;
  let tabChangeCount = 0;

  // ---------------- TIMER ----------------
  function startTimer(durationInSeconds, display) {
    let timer = durationInSeconds;
    if (timerInterval) clearInterval(timerInterval);

    timerInterval = setInterval(() => {
      let minutes = Math.floor(timer / 60);
      let seconds = timer % 60;

      minutes = minutes < 10 ? "0" + minutes : minutes;
      seconds = seconds < 10 ? "0" + seconds : seconds;

      display.textContent = minutes + ":" + seconds;

      if (timer <= 60) {
        display.classList.remove('warning');
        display.classList.add('danger');
      } else if (timer <= 600) {
        display.classList.remove('danger');
        display.classList.add('warning');
      } else {
        display.classList.remove('warning', 'danger');
      }

      if (--timer < 0) {
        clearInterval(timerInterval);
        alert("Time is up! Submitting test...");
        examActive = false;   // ✅ disable restrictions
        examForm.submit();
      }
    }, 1000);
  }

  startTimer(60 * 60, display); // 60 minutes

  // ---------------- SHOW QUESTION ----------------
  function showQuestion(index) {
    currentQuestionIndex = index;
    questions.forEach((q,i)=> q.style.display = (i===index)?"block":"none");

    document.querySelectorAll('.question-grid button').forEach((btn,i)=>{
      btn.classList.remove('active-question');
      if(btn.dataset.answered==="true") btn.classList.add('answered');
      else btn.classList.remove('answered');
      if(i===index) btn.classList.add('active-question'); // blue current
    });

    document.getElementById('prev-btn').style.display = index===0?'none':'inline-block';
    document.getElementById('next-btn').style.display = index===questions.length-1?'none':'inline-block';
    document.getElementById('submit-btn').style.display = index===questions.length-1?'inline-block':'none';
  }

  window.goToQuestion = function(index) {
    currentQuestionIndex = index;
    showQuestion(currentQuestionIndex);
  }

  // ---------------- TRACK ANSWERS ----------------
  document.querySelectorAll('.question input[type=radio]').forEach(input=>{
    input.addEventListener('change', ()=>{
      const qIndex = parseInt(input.closest('.question').dataset.index);
      const btn = document.getElementById('qbtn-'+qIndex);
      btn.dataset.answered = "true";
      btn.classList.add('answered');
    });
  });

  // ---------------- NAVIGATION ----------------
  document.getElementById('next-btn').addEventListener('click', ()=>{
    if(currentQuestionIndex < questions.length-1) showQuestion(currentQuestionIndex+1);
  });
  document.getElementById('prev-btn').addEventListener('click', ()=>{
    if(currentQuestionIndex >0) showQuestion(currentQuestionIndex-1);
  });

  // ---------------- SUBMIT ----------------
  examForm.addEventListener('submit', (e)=>{
    if(!confirm("Submit your test?")) {
        e.preventDefault();
        return;
    }
    examActive = false;  // ✅ allow leaving after submit
  });

  // ---------------- TAB CHANGE RESTRICTION ----------------
  document.addEventListener("visibilitychange", function () {
      if (document.hidden && examActive) {
          tabChangeCount++;
          alert("⚠️ Warning: You switched tabs! Attempt " + tabChangeCount + " of 3");

          if (tabChangeCount >= 3) {
              alert("❌ You switched tabs 3 times. Exam will be auto-submitted.");
              examActive = false;   // ✅ disable restrictions
              examForm.submit();
          }
      }
  });

  // ---------------- PREVENT REFRESH / LEAVE ----------------
  window.addEventListener("beforeunload", function (e) {
      if (examActive) {
          e.preventDefault();
          e.returnValue = "You cannot leave or refresh until you finish the exam!";
          return "You cannot leave or refresh until you finish the exam!";
      }
  });

  // ---------------- INITIALIZE ----------------
  showQuestion(currentQuestionIndex);
});
</script>

</body>
</html>
